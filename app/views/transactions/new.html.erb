
<div class="container">
  <div class="container layout-card">
    <h1>Donation Calculator</h1>
    <h2>Donate to: <em><%= @charity.name %></em> </h2>
    <div class="row">
    <div class="col-8-md">
      <table class="table">
        <thead>
          <tr>
            <th>Items needed</th>
            <th>Item</th>
            <th>Price</th>
            <th>Donation Quantity</th>
          </tr>
        </thead>
        <tbody id="items">

          <% @charity.items.each do |item| %>
          <tr>
            <td>
              <%= item.quantity %>
            </td>
            <td>
              <%= item.name.capitalize.pluralize %>
            </td>
            <td>
              <%= number_with_precision(item.price, precision: 2)  %>
            </td>
            <td>
              <input type="number" class="in" min="0" max= "<%= item.quantity %>" >
            </td>
          </tr>
          <% end %>
        </tbody>
      </table>


      <div id="large-box">
        <div id="small-box">
          <p id="percent"></p>
        </div>
      </div>

      <p>We have raised $<span id="total" class="totalvalue"><%= @total %></span> of the $<span id="goal"><%= number_with_precision(@goal, precision: 2) %></span> goal!</p>

      <input type="text" id="dollars" readonly="readonly"> <i class=" fa fa-arrow-right fa-1x"></i>
      <input type="text" id="bitcoin" readonly="readonly">

      <div>

      <button type="button" id="prep-donation-btn" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
        Prepare donation
      </button>
      </div>
    </div>
    <div class="col-4-md">
      <h1> sup</h1>
      <!-- Grafiken und Text zu unserem Approach  -->
    </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Donation total</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <p>Dear valued donor, please prepare a donation in the tune of: </p>
        <h1 id="prep-bit-value"></h1>
      </div>
      <div class="modal-body">
        <p>By copying this amount to your clipboard and logging into your crypto wallet. Then paste the amount and copy & paste the following wallet adrress of the Charity you selected: </p>
        <h3><em><%= @charity.name.capitalize %></em></h3>

        <h2>
          <%= @charity_front_wallet %>
        </h2>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <%= link_to "See transactions for #{@charity.name}", charity_transactions_path(@charity), class: "btn btn-primary" %>
        </div>
    </div>
  </div>
</div>

<style>

#large-box {
  width: 100%;
  background-color: lightgrey;
  height: 20px;
  border-radius: 4px;
  display: flex;
}

#small-box {
  background-color: blue;
  height: 20px;
  display:flex;
  justify-content: center;
  align-items: center;
  border-bottom-left-radius: 4px;
  border-top-left-radius: 4px;
  color: white;
}

#percent {
  margin-top:12px;
}

.totalvalue {
  display: none;
}

</style>

<script>
  let totalElement = document.getElementById("total");
  let totalBtc = Number(totalElement.innerText);
  let totalGoal = document.getElementById("goal").innerText;
  let bar = document.getElementById("small-box");
  let percentage = document.getElementById("percent");
  console.log(totalGoal);

  let url = "https://blockchain.info/tobtc?currency=USD&value=1";
  fetch(url)
  .then(response => response.text())
  .then((data) => {
    let btcValue = Number(data)
    let dollarTotal = (totalBtc/btcValue).toFixed(2);
    console.log(dollarTotal);
    totalElement.innerText = dollarTotal
    totalElement.style.display = "inline-block";
    let percent = Math.round((dollarTotal/totalGoal) * 100)
    console.log(percent)
    bar.style.width = `${percent}%`;
    percentage.innerText = `${percent}%`;


  });

</script>


<script>

  let prepBtn = document.getElementById("prep-donation-btn");
  prepBtn.addEventListener("click", function(){
    let bitcoins = document.getElementById("bitcoin").value;
    let title = document.getElementById("prep-bit-value")
    title.innerText = bitcoins;
  })
  function convert()
  {
    const form = document.getElementById("dollars");
    const bitcoin = document.getElementById("bitcoin");
    const items = document.querySelector("tbody");
    const rows = items.querySelectorAll("tr");
    const url_base = "https://blockchain.info/tobtc?currency=USD&value=";
    console.log(rows);

    items.addEventListener("input", (e) => {
      let sum = 0;
      rows.forEach((item) => {
        let elements = item.querySelectorAll("td");
        let input_quantity = parseFloat(item.querySelector(".in").value)
        let price = parseFloat(item.querySelectorAll("td")[2].innerText)
        if (input_quantity && price){
          sum += input_quantity * price
        }
      })
      form.value = "$" + sum + "USD"

      let url = url_base + sum;
      fetch(url)
      .then(response => response.text())
      .then((data) => {
        if (form.value) {
          bitcoin.value = data + " Bitcoin";
        }else{
          bitcoin.value = "";
        }
      });
    })
  }
  convert();
</script>
